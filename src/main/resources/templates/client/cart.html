<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="bg" th:replace="layout/base :: content">
<body>
<section>
    <h1>üõí –ö–æ—à–Ω–∏—Ü–∞</h1>

    <div th:if="${#lists.isEmpty(cart)}" class="empty-state">
        <div class="empty-state-icon">üõí</div>
        <div class="empty-state-text">–ö–æ—à–Ω–∏—Ü–∞—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞</div>
        <p>–î–æ–±–∞–≤–µ—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏ –æ—Ç –∫–∞—Ç–∞–ª–æ–≥–∞</p>
        <a th:href="@{/catalog}" class="btn">
            <span class="nav-icon">üì¶</span> –†–∞–∑–≥–ª–µ–¥–∞–π –∫–∞—Ç–∞–ª–æ–≥–∞
        </a>
    </div>

    <div th:unless="${#lists.isEmpty(cart)}">
        <div class="cart-content">
            <!-- Cart items table -->
            <div class="cart-items">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ö-–≤–æ</th>
                            <th>–û–±—â–æ</th>
                            <th>–ë–µ–ª–µ–∂–∫–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${cart}" class="cart-item-row">
                            <td class="product-info">
                                <div class="product-name" th:text="${item.name}">Product Name</div>
                                <div class="product-sku" th:text="${item.sku}">SKU</div>
                            </td>
                            <td class="price-cell">
                                <span th:text="${#numbers.formatDecimal(item.price,1,2)}">0.00</span> –ª–≤
                            </td>
                            <td class="quantity-cell">
                                <div class="quantity-display">
                                    <span class="qty-amount" th:text="${item.qty}">1</span>
                                    <span class="qty-unit">–±—Ä</span>
                                </div>
                            </td>
                            <td class="total-cell">
                                <strong th:text="${#numbers.formatDecimal(item.total(),1,2)}">0.00</strong> –ª–≤
                            </td>
                            <td class="note-cell">
                                <form method="post" th:action="@{/cart/update}" class="update-form">
                                    <div th:replace="~{layout/fragments :: csrf}"></div>
                                    <input type="hidden" name="sku" th:value="${item.sku}" />

                                    <div class="quantity-controls">
                                        <button type="button" class="qty-btn qty-minus" onclick="updateQuantity(this, -1)">-</button>
                                        <input type="number"
                                               name="qty"
                                               th:value="${item.qty}"
                                               min="1"
                                               max="9999"
                                               class="qty-input" />
                                        <button type="button" class="qty-btn qty-plus" onclick="updateQuantity(this, 1)">+</button>
                                    </div>

                                    <input type="text"
                                           name="note"
                                           th:value="${item.note}"
                                           placeholder="–ë–µ–ª–µ–∂–∫–∞..."
                                           class="note-input" />

                                    <button type="submit" class="btn btn-sm btn-secondary">
                                        <span class="nav-icon">üíæ</span> –û–±–Ω–æ–≤–∏
                                    </button>
                                </form>
                            </td>
                            <td class="actions-cell">
                                <form method="post" th:action="@{/cart/update}" class="remove-form"
                                      onsubmit="return confirmRemove(this);">
                                    <div th:replace="~{layout/fragments :: csrf}"></div>
                                    <input type="hidden" name="sku" th:value="${item.sku}" />
                                    <input type="hidden" name="qty" value="0" />
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <span class="nav-icon">üóëÔ∏è</span> –ü—Ä–µ–º–∞—Ö–Ω–∏
                                    </button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cart summary -->
            <div class="cart-summary">
                <div class="summary-header">
                    <h3>–û–±–æ–±—â–µ–Ω–∏–µ</h3>
                </div>

                <div class="summary-row">
                    <span>–ë—Ä–æ–π –∞—Ä—Ç–∏–∫—É–ª–∏:</span>
                    <strong th:text="${itemCount ?: #lists.size(cart)}">0</strong>
                </div>

                <div class="summary-row">
                    <span>–û–±—â–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                    <strong>
                        <span th:text="${#aggregates.sum(cart.![qty])}">0</span> –±—Ä
                    </strong>
                </div>

                <div class="summary-row total-row">
                    <span>–û–±—â–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç:</span>
                    <strong class="total-amount">
                        <span th:text="${#numbers.formatDecimal(totalAmount ?: #aggregates.sum(cart.![total()]),1,2)}">0.00</span> –ª–≤
                    </strong>
                </div>

                <!-- Order notes and submit -->
                <div class="submit-section">
                    <form method="post" th:action="@{/cart/submit}" class="submit-form">
                        <div th:replace="~{layout/fragments :: csrf}"></div>

                        <div class="form-group">
                            <label for="notes">–ë–µ–ª–µ–∂–∫–∏ –∫—ä–º –∑–∞—è–≤–∫–∞—Ç–∞:</label>
                            <textarea id="notes"
                                      name="notes"
                                      rows="3"
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ —É–∫–∞–∑–∞–Ω–∏—è, –∞–¥—Ä–µ—Å –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞, –∏ –¥—Ä."
                                      maxlength="2000"></textarea>
                            <small class="help-text">–ú–∞–∫—Å–∏–º—É–º 2000 —Å–∏–º–≤–æ–ª–∞</small>
                        </div>

                        <div class="submit-actions">
                            <button type="submit" class="btn btn-success submit-btn">
                                <span class="nav-icon">üöÄ</span> –ò–∑–ø—Ä–∞—Ç–∏ –∑–∞—è–≤–∫–∞—Ç–∞
                            </button>

                            <button type="button" class="btn btn-secondary" onclick="clearCart()">
                                <span class="nav-icon">üóëÔ∏è</span> –ò–∑—á–∏—Å—Ç–∏ –∫–æ—à–Ω–∏—Ü–∞—Ç–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick navigation -->
    <div class="quick-actions">
        <a th:href="@{/catalog}" class="btn btn-secondary">
            <span class="nav-icon">üì¶</span> –ü—Ä–æ–¥—ä–ª–∂–∏ –ø–∞–∑–∞—Ä—É–≤–∞–Ω–µ—Ç–æ
        </a>
        <a th:href="@{/orders}" class="btn btn-secondary">
            <span class="nav-icon">üìã</span> –ú–æ–∏—Ç–µ –∑–∞—è–≤–∫–∏
        </a>
    </div>
</section>

<!-- Clear cart confirmation modal -->
<div id="clearCartModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeClearCartModal()">√ó</button>
        <h3 class="modal-title">–ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ</h3>
        <p>–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—á–∏—Å—Ç–∏—Ç–µ –∫–æ—à–Ω–∏—Ü–∞—Ç–∞?</p>
        <div class="modal-actions">
            <form method="post" th:action="@{/cart/clear}">
                <div th:replace="~{layout/fragments :: csrf}"></div>
                <button type="submit" class="btn btn-danger">–î–∞, –∏–∑—á–∏—Å—Ç–∏</button>
                <button type="button" class="btn btn-secondary" onclick="closeClearCartModal()">–û—Ç–∫–∞–∑</button>
            </form>
        </div>
    </div>
</div>

<style>
    .cart-content {
        display: grid;
        gap: 30px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .product-info {
        min-width: 200px;
    }

    .product-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .product-sku {
        font-size: 0.8rem;
        color: #7f8c8d;
        font-family: monospace;
    }

    .quantity-display {
        text-align: center;
    }

    .qty-amount {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .qty-unit {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-left: 4px;
    }

    .price-cell, .total-cell {
        text-align: right;
        white-space: nowrap;
    }

    .total-cell strong {
        color: #27ae60;
        font-size: 1.1rem;
    }

    .update-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
    }

    .note-input {
        width: 150px;
        font-size: 0.85rem;
    }

    .cart-summary {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
    }

    .summary-header h3 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }

    .total-row {
        font-size: 1.2rem;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #eee;
    }

    .total-amount {
        color: #27ae60;
    }

    .submit-section {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .submit-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .submit-btn {
        flex: 1;
        min-width: 180px;
    }

    .help-text {
        color: #7f8c8d;
        font-size: 0.8rem;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    @media (max-width: 768px) {
        .cart-content {
            grid-template-columns: 1fr;
        }

        .table {
            font-size: 0.85rem;
        }

        .update-form {
            align-items: center;
        }

        .note-input {
            width: 100%;
        }

        .submit-actions {
            flex-direction: column;
        }

        .cart-summary {
            position: static;
        }
    }

    @media (max-width: 576px) {
        .table th, .table td {
            padding: 8px 6px;
        }

        .quantity-controls {
            scale: 0.9;
        }
    }
</style>

<script>
    function updateQuantity(button, change) {
        const input = button.parentElement.querySelector('.qty-input');
        const currentValue = parseInt(input.value);
        const newValue = Math.max(1, Math.min(9999, currentValue + change));
        input.value = newValue;
    }

    function confirmRemove(form) {
        const productName = form.closest('tr').querySelector('.product-name').textContent;
        return confirm(`–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ "${productName}" –æ—Ç –∫–æ—à–Ω–∏—Ü–∞—Ç–∞?`);
    }

    function clearCart() {
        document.getElementById('clearCartModal').classList.add('show');
    }

    function closeClearCartModal() {
        document.getElementById('clearCartModal').classList.remove('show');
    }

    // Form submission handling
    document.addEventListener('DOMContentLoaded', function() {
        // Submit form handling
        const submitForm = document.querySelector('.submit-form');
        if (submitForm) {
            submitForm.addEventListener('submit', function(e) {
                const button = this.querySelector('.submit-btn');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading"></span> –ò–∑–ø—Ä–∞—â–∞...';
                button.disabled = true;
            });
        }

        // Update forms handling
        const updateForms = document.querySelectorAll('.update-form');
        updateForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const button = this.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading"></span>';
                button.disabled = true;
            });
        });
    });

    // Close modal on outside click
    document.getElementById('clearCartModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeClearCartModal();
        }
    });
</script>
</body>
</html>