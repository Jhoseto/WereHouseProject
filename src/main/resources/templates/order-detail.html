<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Поръчка №' + ${order.id} + ' - Съни Комерс'">Поръчка №1 - Съни Комерс</title>
    <meta name="description" content="Детайли за поръчка в системата на Съни Комерс.">

    <th:block th:replace="~{fragments/topHtmlImports :: topImports}"></th:block>
    <link rel="stylesheet" href="/css/order-detail.css">
</head>
<body>

<!-- Flash Messages Data -->
<div th:replace="~{fragments/toastSystem :: flashData}"></div>

<!-- Навигация -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Toast Container -->
<div th:replace="~{fragments/toastSystem :: toastContainer}"></div>

<section class="order-detail-section" th:object="${order}">
    <div class="container">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs">
            <a href="/" class="breadcrumb-link">
                <i class="bi bi-house"></i>
                Начало
            </a>
            <i class="bi bi-chevron-right breadcrumb-separator"></i>
            <a href="/orders" class="breadcrumb-link">
                <i class="bi bi-bag-check"></i>
                Моите поръчки
            </a>
            <i class="bi bi-chevron-right breadcrumb-separator"></i>
            <span class="breadcrumb-current">Поръчка #<span th:text="*{id}">0</span></span>
        </div>

        <!-- Order Header -->
        <div class="order-header">
            <div class="header-main">
                <div class="order-title">
                    <h1>
                        <i class="bi bi-receipt"></i>
                        Поръчка № <span class="order-number" th:text="*{id}">0</span>
                    </h1>
                    <div class="order-status-wrapper">
                        <span th:class="'status-badge status-' + ${#strings.toLowerCase(order.status.name())}"
                              th:attr="title=${order.status.name() == 'SUBMITTED' ? 'Очаква потвърждение от администратор' :
                                           (order.status.name() == 'CONFIRMED' ? 'Потвърдена и се обработва' :
                                           (order.status.name() == 'SHIPPED' ? 'Изпратена за доставка' :
                                           (order.status.name() == 'CANCELLED' ? 'Поръчката е отменена' : order.status.name())))}">
                            <i th:class="${order.status.name() == 'SUBMITTED' ? 'bi bi-clock' :
                                        (order.status.name() == 'CONFIRMED' ? 'bi bi-check-circle' :
                                        (order.status.name() == 'SHIPPED' ? 'bi bi-truck' :
                                        (order.status.name() == 'CANCELLED' ? 'bi bi-x-circle' : 'bi bi-question-circle')))}"></i>
                            <span th:text="${order.status.name() == 'SUBMITTED' ? 'Подадена' :
                                         (order.status.name() == 'CONFIRMED' ? 'Потвърдена' :
                                         (order.status.name() == 'SHIPPED' ? 'Изпратена' :
                                         (order.status.name() == 'CANCELLED' ? 'Отменена' : order.status.name())))}">Подадена</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Edit Controls (only for SUBMITTED orders) -->
            <div th:if="${canEdit}" class="header-actions">
                <button type="button" id="editModeToggle" class="btn btn-outline edit-toggle-btn">
                    <i class="bi bi-pencil-square"></i>
                    <span class="edit-text">Редактирай</span>
                </button>
            </div>
        </div>

        <!-- Edit Mode Notice -->
        <div th:if="${canEdit}" class="edit-notice" id="editModeNotice" style="display: none;">
            <div class="notice-content">
                <i class="bi bi-info-circle notice-icon"></i>
                <span class="notice-text">Режим на редактиране - можете да променяте количествата и да премахвате артикули</span>
                <button type="button" id="exitEditMode" class="notice-close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        <!-- Order Info Grid -->
        <div class="order-info-grid">
            <!-- Order Details Card -->
            <div class="info-card">
                <div class="card-header">
                    <h3>
                        <i class="bi bi-calendar-event"></i>
                        Информация за поръчката
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">
                            <i class="bi bi-calendar-plus"></i>
                            Подадена на:
                        </span>
                        <span class="info-value" th:text="${#temporals.format(order.submittedAt, 'dd.MM.yyyy HH:mm:ss')}">01.01.2025 12:00:00</span>
                    </div>
                    <div th:if="*{confirmedAt != null}" class="info-row">
                        <span class="info-label">
                            <i class="bi bi-calendar-check"></i>
                            Потвърдена на:
                        </span>
                        <span class="info-value confirmed-date" th:text="${#temporals.format(order.confirmedAt, 'dd.MM.yyyy HH:mm:ss')}">01.01.2025 13:00:00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">
                            <i class="bi bi-boxes"></i>
                            Брой артикули:
                        </span>
                        <span class="info-value" th:text="${order.items.size()}">0</span>
                    </div>
                    <div th:if="*{notes != null and not #strings.isEmpty(notes)}" class="info-row notes-row">
                        <span class="info-label">
                            <i class="bi bi-chat-left-text"></i>
                            Бележки:
                        </span>
                        <div class="info-value notes-content" th:text="*{notes}">Order notes</div>
                    </div>
                </div>
            </div>

            <!-- Order Summary Card -->
            <div class="summary-card">
                <div class="card-header">
                    <h3>
                        <i class="bi bi-calculator"></i>
                        Финансова информация
                    </h3>
                </div>
                <div class="card-body">
                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="bi bi-cash"></i>
                            Нето сума:
                        </span>
                        <span class="summary-amount" id="totalNet" th:text="${#numbers.formatDecimal(order.totalNet,1,2)} + ' лв'">0.00 лв</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="bi bi-percent"></i>
                            ДДС:
                        </span>
                        <span class="summary-amount" id="totalVat" th:text="${#numbers.formatDecimal(order.totalVat,1,2)} + ' лв'">0.00 лв</span>
                    </div>
                    <div class="summary-row total-row">
                        <span class="summary-label">
                            <i class="bi bi-currency-dollar"></i>
                            Крайна сума:
                        </span>
                        <strong class="total-amount" id="totalGross" th:text="${#numbers.formatDecimal(order.totalGross,1,2)} + ' лв'">0.00 лв</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items Section -->
        <div class="order-items-section">
            <div class="section-header">
                <h3>
                    <i class="bi bi-box-seam"></i>
                    Продукти в поръчката
                </h3>
            </div>

            <div class="items-table-wrapper">
                <div class="table-container">
                    <table class="items-table">
                        <thead class="table-header">
                        <tr>
                            <th class="col-sku">
                                <i class="bi bi-upc-scan"></i>
                                SKU
                            </th>
                            <th class="col-product">
                                <i class="bi bi-box"></i>
                                Наименование
                            </th>
                            <th class="col-quantity">
                                <i class="bi bi-123"></i>
                                Количество
                            </th>
                            <th class="col-price">
                                <i class="bi bi-tag"></i>
                                Ед. цена
                            </th>
                            <th class="col-total">
                                <i class="bi bi-calculator"></i>
                                Сума
                            </th>
                            <th th:if="${canEdit}" class="col-actions edit-column">
                                <i class="bi bi-gear"></i>
                                Действия
                            </th>
                        </tr>
                        </thead>
                        <tbody class="table-body">
                        <tr th:each="item : ${order.items}"
                            class="item-row"
                            th:attr="data-product-id=${item.product.id}">

                            <!-- SKU -->
                            <td class="sku-cell">
                                <span class="product-sku" th:text="${item.product.sku}">SKU001</span>
                            </td>

                            <!-- Product Name -->
                            <td class="product-cell">
                                <div class="product-info">
                                    <div class="product-name" th:text="${item.product.name}">Product Name</div>
                                    <div th:if="${item.product.description}" class="product-description" th:text="${item.product.description}">Description</div>
                                </div>
                            </td>

                            <!-- Quantity -->
                            <td class="quantity-cell">
                                <div class="quantity-display">
                                    <span class="quantity-value" th:text="${#numbers.formatInteger(item.qty,1)}">1</span>
                                    <span class="quantity-unit" th:text="${item.product.unit}">бр</span>
                                </div>

                                <!-- Edit Quantity Controls (hidden by default) -->
                                <div th:if="${canEdit}" class="quantity-edit-panel" style="display: none;">
                                    <div class="quantity-controls">
                                        <button type="button" class="quantity-btn quantity-decrease">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number"
                                               class="quantity-input"
                                               th:value="${#numbers.formatInteger(item.qty,1)}"
                                               min="1"
                                               max="999">
                                        <button type="button" class="quantity-btn quantity-increase">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div class="quantity-actions">
                                        <button type="button" class="btn btn-xs btn-primary update-quantity-btn">
                                            <i class="bi bi-check"></i>
                                            Обнови
                                        </button>
                                        <button type="button" class="btn btn-xs btn-outline cancel-quantity-btn">
                                            <i class="bi bi-x"></i>
                                            Отказ
                                        </button>
                                    </div>
                                </div>
                            </td>

                            <!-- Unit Price -->
                            <td class="price-cell">
                                <span class="unit-price" th:text="${#numbers.formatDecimal(item.unitPrice,1,2)} + ' лв'">0.00 лв</span>
                            </td>

                            <!-- Total Price -->
                            <td class="total-cell">
                                <strong class="item-total" th:text="${#numbers.formatDecimal(item.unitPrice * item.qty,1,2)} + ' лв'">0.00 лв</strong>
                            </td>

                            <!-- Actions (only in edit mode) -->
                            <td th:if="${canEdit}" class="actions-cell edit-column">
                                <div class="item-actions" style="display: none;">
                                    <button type="button" class="btn btn-xs btn-outline edit-quantity-btn">
                                        <i class="bi bi-pencil"></i>
                                        Промени
                                    </button>
                                    <button type="button" class="btn btn-xs btn-danger remove-item-btn">
                                        <i class="bi bi-trash"></i>
                                        Премахни
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="order-actions-section">
            <div class="actions-wrapper">
                <div class="primary-actions">
                    <a href="/orders" class="btn btn-outline">
                        <i class="bi bi-arrow-left"></i>
                        Назад към поръчките
                    </a>
                </div>

                <div th:if="${canEdit}" class="edit-actions" id="saveChangesSection" style="display: none;">
                    <button type="button" id="saveAllChanges" class="btn btn-success">
                        <i class="bi bi-floppy"></i>
                        Запази промените
                    </button>
                    <button type="button" id="cancelAllChanges" class="btn btn-outline">
                        <i class="bi bi-x-circle"></i>
                        Отказ
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <i class="bi bi-arrow-repeat"></i>
        </div>
        <p class="loading-text">Обработване...</p>
    </div>
</div>

<!-- Include Footer Fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="/js/order-detail.js"></script>
<th:block th:replace="~{fragments/bottomHtmlImports :: bottomImports}"></th:block>

</body>
</html>