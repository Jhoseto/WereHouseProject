<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Детайли на поръчка'">Детайли на поръчка</title>

    <!-- Include Head Fragment -->
    <div th:replace="~{fragments/topHtmlImports :: topImports}"></div>

    <!-- Order Detail Specific CSS -->
    <link rel="stylesheet" th:href="@{/css/order-detail-client.css}">
</head>
<body>

<!-- Навигация -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Main Content -->
<section class="order-detail-section">
    <div class="container">

        <!-- Breadcrumbs -->
        <nav class="breadcrumbs">
            <a href="/" class="breadcrumb-link">
                <i class="bi bi-house"></i>
                Начало
            </a>
            <span class="breadcrumb-separator">›</span>
            <a href="/orders" class="breadcrumb-link">
                <i class="bi bi-list-ul"></i>
                Моите поръчки
            </a>
            <span class="breadcrumb-separator">›</span>
            <span class="breadcrumb-current" th:text="'Поръчка №' + ${order.id}">Поръчка №123</span>
        </nav>

        <!-- Order Header -->
        <div class="order-header">
            <div class="header-main">
                <div class="order-title">
                    <h1>
                        <i class="bi bi-receipt"></i>
                        Поръчка №<span class="order-number" th:text="${order.id}">123</span>
                    </h1>
                </div>
                <div class="order-status-wrapper">
                    <span class="status-badge"
                          th:classappend="'status-' + ${order.status.name().toLowerCase()}"
                          th:title="${order.status.name() == 'URGENT' ? 'Спешна поръчка' :
                                   (order.status.name() == 'PENDING' ? 'Изчакваща обработка' :
                                   (order.status.name() == 'CONFIRMED' ? 'Потвърдена от екипа' :
                                   (order.status.name() == 'SHIPPED' ? 'Изпратена за доставка' :
                                   (order.status.name() == 'CANCELLED' ? 'Поръчката е отменена' : order.status.name()))))}">
                        <i th:class="${order.status.name() == 'URGENT' ? 'bi bi-exclamation-triangle' :
                                    (order.status.name() == 'PENDING' ? 'bi bi-clock' :
                                    (order.status.name() == 'CONFIRMED' ? 'bi bi-check-circle' :
                                    (order.status.name() == 'SHIPPED' ? 'bi bi-truck' :
                                    (order.status.name() == 'CANCELLED' ? 'bi bi-x-circle' : 'bi bi-question-circle'))))}"></i>
                        <span th:text="${order.status.name() == 'URGENT' ? 'Спешна' :
                                     (order.status.name() == 'PENDING' ? 'Изчакваща' :
                                     (order.status.name() == 'CONFIRMED' ? 'Потвърдена' :
                                     (order.status.name() == 'SHIPPED' ? 'Изпратена' :
                                     (order.status.name() == 'CANCELLED' ? 'Отменена' : order.status.name()))))}">Подадена</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Order Info Grid -->
        <div class="order-info-grid">
            <!-- Order Details Card -->
            <div class="info-card">
                <div class="card-header">
                    <h3>
                        <i class="bi bi-calendar-event"></i>
                        Информация за поръчката
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">
                            <i class="bi bi-calendar-plus"></i>
                            Подадена на:
                        </span>
                        <span class="info-value" th:text="${#temporals.format(order.submittedAt, 'dd.MM.yyyy HH:mm:ss')}">01.01.2025 12:00:00</span>
                    </div>
                    <div th:if="*{confirmedAt != null}" class="info-row">
                        <span class="info-label">
                            <i class="bi bi-check-circle"></i>
                            Потвърдена на:
                        </span>
                        <span class="info-value" th:text="${#temporals.format(order.confirmedAt, 'dd.MM.yyyy HH:mm:ss')}">02.01.2025 10:30:00</span>
                    </div>
                    <div th:if="*{shippedAt != null}" class="info-row">
                        <span class="info-label">
                            <i class="bi bi-truck"></i>
                            Изпратена на:
                        </span>
                        <span class="info-value" th:text="${#temporals.format(order.shippedAt, 'dd.MM.yyyy HH:mm:ss')}">03.01.2025 14:15:00</span>
                    </div>
                    <div th:if="*{notes != null and !#strings.isEmpty(notes)}" class="info-row">
                        <span class="info-label">
                            <i class="bi bi-chat-left-text"></i>
                            Бележки:
                        </span>
                        <span class="info-value" th:text="${order.notes}">Моля, доставете до адрес</span>
                    </div>
                </div>
            </div>

            <!-- Order Summary Card -->
            <div class="summary-card">
                <div class="card-header">
                    <h3>
                        <i class="bi bi-calculator"></i>
                        Обобщение на поръчката
                    </h3>
                </div>
                <div class="card-body">
                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="bi bi-tag"></i>
                            Стойност без ДДС:
                        </span>
                        <span class="summary-amount" id="totalNet" th:text="${#numbers.formatDecimal(order.totalNet, 1, 2)} + ' лв.'">150.00 лв.</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="bi bi-percent"></i>
                            ДДС:
                        </span>
                        <span class="summary-amount" id="totalVat" th:text="${#numbers.formatDecimal(order.totalVat, 1, 2)} + ' лв.'">30.00 лв.</span>
                    </div>
                    <div class="summary-row total-row">
                        <span class="summary-label">
                            <i class="bi bi-currency-exchange"></i>
                            Общо с ДДС:
                        </span>
                        <span class="total-amount" id="totalGross" th:text="${#numbers.formatDecimal(order.totalGross, 1, 2)} + ' лв.'">180.00 лв.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items Section -->
        <div class="order-items-section">
            <div class="section-header">
                <h3>
                    <i class="bi bi-box-seam"></i>
                    Артикули в поръчката
                    <span class="items-count" th:text="'(' + ${order.items.size()} + ' артикула)'"> (3 артикула)</span>
                </h3>
            </div>

            <div class="items-table-wrapper">
                <table class="items-table">
                    <thead class="table-header">
                    <tr>
                        <th><i class="bi bi-upc-scan"></i> Код</th>
                        <th><i class="bi bi-box"></i> Продукт</th>
                        <th><i class="bi bi-hash"></i> Количество</th>
                        <th><i class="bi bi-currency-euro"></i> Ед. цена</th>
                        <th><i class="bi bi-calculator"></i> Общо</th>
                        <th th:if="${canEdit}"><i class="bi bi-gear"></i> Действия</th>
                    </tr>
                    </thead>
                    <tbody class="table-body">
                    <tr th:each="item : ${order.items}"
                        class="item-row"
                        th:data-product-id="${item.product.id}"
                        th:data-original-quantity="${item.qty}"
                        th:data-unit-price="${item.unitPrice}">

                        <!-- SKU -->
                        <td class="sku-cell">
                            <span class="product-sku" th:text="${item.product.sku}">PR001</span>
                        </td>

                        <!-- Product Info -->
                        <td class="product-cell">
                            <div class="product-name" th:text="${item.product.name}">Продукт 1</div>
                            <div th:if="${item.product.description != null and !#strings.isEmpty(item.product.description)}"
                                 class="product-description"
                                 th:text="${item.product.description}">Описание на продукта</div>
                        </td>

                        <!-- Quantity (Editable if canEdit) -->
                        <td class="quantity-cell">
                            <div th:if="${!canEdit}" class="quantity-display">
                                <span class="quantity-value" th:text="${item.qty}">2</span>
                                <span class="quantity-unit">бр.</span>
                            </div>
                            <div th:if="${canEdit}" class="quantity-edit">
                                <div class="quantity-input-wrapper">
                                    <button type="button" class="quantity-btn quantity-decrease">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number"
                                           class="quantity-input"
                                           th:value="${item.qty}"
                                           min="1"
                                           max="999">
                                    <button type="button" class="quantity-btn quantity-increase">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <span class="quantity-unit">бр.</span>
                            </div>
                        </td>

                        <!-- Unit Price -->
                        <td class="price-cell">
                            <span class="unit-price" th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)} + ' лв.'">25.00 лв.</span>
                        </td>

                        <!-- Total Price -->
                        <td class="price-cell">
                                <span class="item-total"
                                      th:text="${#numbers.formatDecimal(item.unitPrice.multiply(item.qty), 1, 2)} + ' лв.'">50.00 лв.</span>
                        </td>

                        <!-- Actions (only if editable) -->
                        <td th:if="${canEdit}" class="actions-cell">
                            <button type="button" class="remove-item-btn" title="Премахни артикул">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="order-actions-section">
            <div class="actions-wrapper">
                <div class="primary-actions">
                    <a href="/orders" class="btn btn-outline">
                        <i class="bi bi-arrow-left"></i>
                        Назад към поръчките
                    </a>
                </div>

                <div th:if="${canEdit}" class="edit-actions">
                    <button type="button" id="saveChanges" class="btn btn-success" disabled>
                        <i class="bi bi-floppy"></i>
                        Запази промените
                    </button>
                    <button type="button" id="resetChanges" class="btn btn-outline" disabled>
                        <i class="bi bi-arrow-clockwise"></i>
                        Върни оригиналните стойности
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Footer Fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="/js/order-detail.js"></script>
<th:block th:replace="~{fragments/bottomHtmlImports :: bottomImports}"></th:block>

</body>
</html>