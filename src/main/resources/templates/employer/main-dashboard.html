<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="bg">

<head>
    <title>Обработка на поръчки | Warehouse Portal</title>

    <!-- Standard project imports -->
    <div th:replace="~{fragments/topHtmlImports :: topImports}"></div>

    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="/css/employerDashboard.css">
</head>

<body>
<!-- Flash Messages Data -->
<div th:replace="~{fragments/toastSystem :: flashData}"></div>

<!-- Navigation -->
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div th:replace="~{fragments/toastSystem :: toastContainer}"></div>

<!-- Compact Header with WebSocket Status -->
<header class="processing-header">
    <div class="header-container">
        <!-- Title and Live Status -->
        <div class="header-title-section">
            <h1 class="processing-title">Обработка на поръчки</h1>
            <div class="live-status-indicator"
                 title="Показва състоянието на real-time връзката за автоматично обновяване на данните">
                <div class="live-dot" id="websocket-indicator"></div>
                <span class="live-text" id="websocket-status">Свързване...</span>
            </div>
        </div>
    </div>
</header>

<!-- FILTER & SORT PANEL - Поставете този HTML в main-dashboard.html ДИРЕКТНО СЛЕД <div class="dashboard-header"> -->

<div class="filter-sort-panel" id="filter-sort-panel">
    <div class="filter-panel-header">
        <div class="panel-title">
            <i class="bi bi-funnel"></i>
            <span>Филтриране и сортиране</span>
            <span class="active-tab-indicator" id="active-tab-name">Изчакващи поръчки</span>
        </div>
        <div class="panel-controls">
            <button class="btn-toggle-filters" id="toggle-filters" title="Скрий/Покажи филтри">
                <i class="bi bi-chevron-up"></i>
            </button>
            <button class="btn-reset-filters" id="reset-filters" title="Изчисти всички филтри">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <div class="filter-panel-content" id="filter-panel-content">
        <!-- ТЪРСЕНЕ И СОРТИРАНЕ -->
        <div class="filter-row">
            <div class="filter-group">
                <label for="search-input">Търсене</label>
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text"
                           id="search-input"
                           class="filter-input"
                           placeholder="Търси по фирма, име, телефон..."
                           autocomplete="off">
                </div>
            </div>
        </div>

        <!-- ФИЛТРИ ПЕРИОД -->
        <div class="filter-row">
            <div class="filter-group">
                <label for="period-filter">Период</label>
                <select id="period-filter" class="filter-select">
                    <option value="">Всички периоди</option>
                    <option value="today">Днес</option>
                    <option value="yesterday">Вчера</option>
                    <option value="last-3-days">Последни 3 дни</option>
                    <option value="this-week">Тази седмица</option>
                    <option value="last-week">Миналата седмица</option>
                    <option value="this-month">Този месец</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sort-select">Сортиране</label>
                <select id="sort-select" class="filter-select">
                    <option value="newest">Най-нови първо</option>
                    <option value="oldest">Най-стари първо</option>
                    <option value="amount-high">Най-скъпи първо</option>
                    <option value="amount-low">Най-евтини първо</option>
                    <option value="items-most">Повече артикули първо</option>
                    <option value="items-least">По-малко артикули първо</option>
                    <option value="company-az">Фирма А-Я</option>
                    <option value="company-za">Фирма Я-А</option>
                    <option value="client-az">Клиент А-Я</option>
                    <option value="client-za">Клиент Я-А</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="location-filter">Локация</label>
                <select id="location-filter" class="filter-select">
                    <option value="">Всички локации</option>
                    <!-- Динамично зареждане от данните -->
                </select>
            </div>
        </div>

        <!-- РЕЗУЛТАТИ И СТАТИСТИКА -->
        <div class="filter-results-row">
            <div class="results-count">
                <span id="filtered-count">0</span> от <span id="total-count">0</span> поръчки
                <span class="active-filters" id="active-filters-text"></span>
            </div>
            <div class="results-stats">
                <span class="stat-item">
                    С ДДС: <strong id="total-amount-filtered">0.00 лв</strong>
                </span>
                <span class="stat-item">
                    Без ДДС: <strong id="total-net-filtered">0.00 лв</strong>
                </span>
                <span class="stat-item">
                    Артикули: <strong id="total-items-filtered">0</strong>
                </span>
            </div>
        </div>
    </div>
</div>


<!-- Enhanced Order Processing Tab Navigation -->
<nav class="processing-tabs">
    <button class="tab-btn active"
            data-tab="urgent"
            onclick="switchTab('urgent')"
            title="Спешни поръчки - над 12 часа без обработка. Изискват незабавно внимание.">
        <i class="tab-icon bi bi-exclamation-triangle-fill"></i>
        <span class="tab-label">Спешни</span>
        <span class="tab-count" id="urgent-tab-count" th:text="${urgentCount ?: 0}">0</span>
    </button>
    <button class="tab-btn"
            data-tab="pending"
            onclick="switchTab('pending')"
            title="Чакащи обработка - нови поръчки получени в последните 12 часа.">
        <i class="tab-icon bi bi-hourglass-split"></i>
        <span class="tab-label">Чакащи</span>
        <span class="tab-count" id="pending-tab-count" th:text="${pendingCount ?: 0}">0</span>
    </button>
    <button class="tab-btn"
            data-tab="confirmed"
            onclick="switchTab('confirmed')"
            title="Обработени поръчки - одобрени и готови за експедиция.">
        <i class="tab-icon bi bi-check-circle-fill"></i>
        <span class="tab-label">Обработени</span>
        <span class="tab-count" id="confirmed-tab-count" th:text="${confirmedCount ?: 0}">0</span>
    </button>
    <button class="tab-btn"
            data-tab="shipped"
            onclick="switchTab('shipped')"
            title="Завършени поръчки - изпратени за доставка.">
        <i class="tab-icon bi bi-truck"></i>
        <span class="tab-label">Завършени</span>
        <span class="tab-count" id="shipped-tab-count" th:text="${shippedCount ?: 0}">0</span>
    </button>
    <button class="tab-btn"
            data-tab="cancelled"
            onclick="switchTab('cancelled')"
            title="Отказани поръчки - отменени заявки за справка и анализ.">
        <i class="tab-icon bi bi-x-circle-fill"></i>
        <span class="tab-label">Отказани</span>
        <span class="tab-count" id="cancelled-tab-count" th:text="${cancelledCount ?: 0}">0</span>
    </button>
</nav>

<!-- ⭐ Loading Spinner -->
<div class="orders-loading-spinner" id="orders-loading-spinner">
    <div class="spinner-content">
        <div class="spinner-circle"></div>
        <p class="spinner-text">Зареждане на поръчки...</p>
    </div>
</div>

<!-- Order Processing Content -->
<main class="processing-content">

    <!-- Urgent Orders Tab -->
    <div class="tab-content active" id="urgent-tab">
        <div class="processing-panel urgent-panel">
            <div class="panel-header urgent-header">
                <div class="panel-title-section">
                    <i class="bi bi-exclamation-triangle-fill panel-icon"></i>
                    <div class="panel-title-text">
                        <h2 class="panel-title">Спешни поръчки</h2>
                        <p class="panel-subtitle">Поръчки над 12 часа - изискват незабавна обработка</p>
                    </div>
                </div>
                <div class="panel-actions">
                    <button class="action-btn refresh-btn" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Обнови</span>
                    </button>
                    <div class="panel-badge urgent-panel-badge" id="urgent-badge" th:text="${urgentCount ?: 0}">0</div>
                </div>
            </div>
            <div class="panel-content">
                <div id="urgent-orders-container" class="orders-container">
                    <div class="orders-list" id="urgent-orders-list">
                        <!-- JavaScript ще генерира order карти тук -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Orders Tab -->
    <div class="tab-content" id="pending-tab">
        <div class="processing-panel pending-panel">
            <div class="panel-header pending-header">
                <div class="panel-title-section">
                    <i class="bi bi-hourglass-split panel-icon"></i>
                    <div class="panel-title-text">
                        <h2 class="panel-title">Чакащи обработка</h2>
                        <p class="panel-subtitle">Нови поръчки получени в последните 12 часа</p>
                    </div>
                </div>
                <div class="panel-actions">
                    <button class="action-btn refresh-btn" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Обнови</span>
                    </button>
                    <div class="panel-badge pending-panel-badge" id="pending-badge" th:text="${pendingCount ?: 0}">0</div>
                </div>
            </div>
            <div class="panel-content">
                <div id="pending-orders-container" class="orders-container">
                    <div class="loading-state">
                        <div class="orders-list" id="pending-orders-list">
                            <!-- JavaScript ще генерира order карти тук -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmed Orders Tab -->
    <div class="tab-content" id="confirmed-tab">
        <div class="processing-panel confirmed-panel">
            <div class="panel-header confirmed-header">
                <div class="panel-title-section">
                    <i class="bi bi-check-circle-fill panel-icon"></i>
                    <div class="panel-title-text">
                        <h2 class="panel-title">Обработени поръчки</h2>
                        <p class="panel-subtitle">Одобрени поръчки готови за изпращане</p>
                    </div>
                </div>
                <div class="panel-actions">
                    <button class="action-btn refresh-btn" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Обнови</span>
                    </button>
                    <div class="panel-badge confirmed-panel-badge" id="confirmed-badge" th:text="${confirmedCount ?: 0}">0</div>
                </div>
            </div>
            <div class="panel-content">
                <div id="confirmed-orders-container" class="orders-container">
                    <div class="loading-state">
                        <div class="orders-list" id="confirmed-orders-list">
                            <!-- JavaScript ще генерира order карти тук -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipped Orders Tab -->
    <div class="tab-content" id="shipped-tab">
        <div class="processing-panel shipped-panel">
            <div class="panel-header shipped-header">
                <div class="panel-title-section">
                    <i class="bi bi-truck panel-icon"></i>
                    <div class="panel-title-text">
                        <h2 class="panel-title">Завършени поръчки</h2>
                        <p class="panel-subtitle">Изпратени поръчки за доставка до клиента</p>
                    </div>
                </div>
                <div class="panel-actions">
                    <button class="action-btn refresh-btn" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Обнови</span>
                    </button>
                    <div class="panel-badge shipped-panel-badge" id="shipped-badge" th:text="${shippedCount ?: 0}">0</div>
                </div>
            </div>
            <div class="panel-content">
                <div id="shipped-orders-container" class="orders-container">
                    <div class="orders-list" id="shipped-orders-list">
                        <!-- JavaScript ще генерира order карти тук -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancelled Orders Tab -->
    <div class="tab-content" id="cancelled-tab">
        <div class="processing-panel cancelled-panel">
            <div class="panel-header cancelled-header">
                <div class="panel-title-section">
                    <i class="bi bi-x-circle-fill panel-icon"></i>
                    <div class="panel-title-text">
                        <h2 class="panel-title">Отказани поръчки</h2>
                        <p class="panel-subtitle">Отменени и архивирани поръчки</p>
                    </div>
                </div>
                <div class="panel-actions">
                    <button class="action-btn refresh-btn" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Обнови</span>
                    </button>
                    <div class="panel-badge cancelled-panel-badge" id="cancelled-badge" th:text="${cancelledCount ?: 0}">0</div>
                </div>
            </div>
            <div class="panel-content">
                <div id="cancelled-orders-container" class="orders-container">
                    <div class="loading-state">
                        <div class="orders-list" id="cancelled-orders-list">
                            <!-- JavaScript ще генерира order карти тук -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Hidden elements for JavaScript compatibility -->
<div style="display: none;">
    <!-- These elements are needed for existing JavaScript to work -->
    <div class="status-item urgent" id="status-urgent"></div>
    <div class="status-item warning" id="status-pending"></div>
    <div class="status-item info" id="status-confirmed"></div>
    <div class="status-item danger" id="status-cancelled"></div>
</div>

<!-- JavaScript Configuration with Real Data -->
<script th:inline="javascript">
    // Enhanced dashboard configuration for production
    window.dashboardConfig = {
        // Server-side data injection
        initialDashboardData: /*[[${initialDashboardData}]]*/ {},
        userId: /*[[${userId}]]*/ null,
        csrfToken: /*[[${csrfToken}]]*/ '',
        csrfHeader: /*[[${csrfHeader}]]*/ 'X-CSRF-TOKEN',
        currentUser: /*[[${currentUser}]]*/ {},

        // Real-time counters for WebSocket updates
        counters: {
            urgent: /*[[${urgentCount}]]*/ 0,
            pending: /*[[${pendingCount}]]*/ 0,
            confirmed: /*[[${confirmedCount}]]*/ 0,
            cancelled: /*[[${cancelledCount}]]*/ 0
        },

        // Daily statistics for rich UI
        dailyStats: {
            processed: /*[[${dailyStats.processed}]]*/ 0,
            revenue: /*[[${dailyStats.revenue}]]*/ 0,
            avgTime: /*[[${dailyStats.avgTime}]]*/ '0.0ч',
            activeClients: /*[[${dailyStats.activeClients}]]*/ 0
        },

        // System metadata
        lastUpdate: /*[[${lastUpdate}]]*/ null,
        serverTime: /*[[${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm:ss')}]]*/ '',

        // WebSocket configuration
        wsConfig: {
            enableAutoReconnect: true,
            maxReconnectAttempts: 5,
            reconnectDelay: 3000,
            heartbeatInterval: 30000
        },

        // UI preferences
        ui: {
            autoRefresh: true,
            refreshInterval: 60000,
            animateCounters: true,
            showNotifications: true
        }
    };

</script>

<!-- Core JavaScript - Bottom Imports -->
<div th:replace="~{fragments/bottomHtmlImports :: bottomImports}"></div>

<!-- Dashboard JavaScript Modules -->
<script src="/js/employersDashboard/dashboardApi.js"></script>
<script src="/js/employersDashboard/dashboardManager.js"></script>
<script src="/js/employersDashboard/dashboardUI.js"></script>
<script src="/js/employersDashboard/mainDashboard.js"></script>
<script src="/js/employersDashboard/filterManagerForOrderManagement.js"></script>

<!-- Enhanced WebSocket Status Management -->
<script>
    // WebSocket status indicator management
    function updateWebSocketStatus(isConnected, message) {
        const container = document.querySelector('.live-status-indicator');
        const indicator = document.getElementById('websocket-indicator');
        const statusText = document.getElementById('websocket-status');

        if (!indicator || !statusText || !container) {
            console.warn('WebSocket status elements not found');
            return;
        }

        if (isConnected) {
            indicator.classList.remove('disconnected');
            indicator.classList.add('connected');
            statusText.textContent = message || 'На живо';

            container.title = 'Системата е свързана със сървъра и получава моментални актуализации.\n ' +
                'Когато дойде нова поръчка или се промени статус, \n ' +
                'ще видите промяната веднага без да опреснявате страницата.';

        } else {
            indicator.classList.remove('connected');
            indicator.classList.add('disconnected');
            statusText.textContent = message || 'Прекъсната връзка';

            if (message && message.includes('Свързване')) {
                container.title = 'Системата се свързва към сървъра.\n Това отнема няколко секунди.';
            } else {
                container.title = 'Връзката към сървъра е прекъсната.\n ' +
                    'Поръчките ще се актуализират автоматично на всеки 30 секунди.\n ' +
                    'Проверете интернет връзката или опреснете страницата.';
            }
        }
    }
    // Initialize WebSocket status on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateWebSocketStatus(false, 'Свързване...');

        // Listen for WebSocket connection events
        if (window.mainDashboard && window.mainDashboard.api) {
            window.mainDashboard.api.onConnectionChange = updateWebSocketStatus;
        }
    });
</script>

</body>
</html>