<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Товарене на поръчка | Shipping Dashboard</title>

    <!-- Core project imports -->
    <div th:replace="~{fragments/topHtmlImports :: topImports}"></div>
    <!-- Order Shipping specific stylesheets -->
    <link rel="stylesheet" href="/css/order-shipping-catalog.css">
</head>
<body>

<!-- Flash Messages for server-side notifications -->
<div th:replace="~{fragments/toastSystem :: flashData}"></div>

<!-- Navigation -->
<div th:replace="~{fragments/navbar :: navbar}"></div>


<!-- Toast notification container -->
<div th:replace="~{fragments/toastSystem.html :: toastContainer}"></div>

<!-- MAIN LOADING INTERFACE - Нов единен интерфейс -->
<section id="main-loading-section" class="order-shipping-section">
    <div class="container">

        <!-- Truck Input Header - Винаги видим най-отгоре -->
        <div class="truck-header-section">
            <div class="shipping-title-block">
                <h1>
                    <i class="bi bi-truck"></i>
                    Товарене на поръчка №<span th:text="${orderId}">123</span>
                </h1>
                <div class="shipping-subtitle">
                    Управление на товарителен процес и мониторинг
                </div>
            </div>

            <!-- Truck Input Controls - Винаги активни -->
            <div class="truck-controls-panel">
                <div class="truck-input-group">
                    <label for="truck-input" class="form-label">
                        <i class="bi bi-truck-front-fill"></i>
                        Номер на камион:
                    </label>
                    <div class="input-button-group">
                        <input type="text"
                               id="truck-input"
                               class="form-control truck-number-input"
                               placeholder="напр. BG1234AB"
                               maxlength="12">
                        <button id="start-loading-btn" class="btn btn-primary" disabled>
                            <i class="bi bi-play-circle"></i>
                            Започни товарене
                        </button>
                    </div>
                    <div class="form-text">Въведете валиден номер на камион (4-12 символа)</div>
                </div>

                <!-- Session Status Indicator -->
                <div id="session-status" class="session-status hidden">
                    <div class="status-indicator loading">
                        <i class="bi bi-hourglass-split"></i>
                        <span>Стартиране на сесия...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area - Неактивна до стартиране -->
        <div id="loading-content" class="loading-content-area disabled">

            <!-- Information Panels Row -->
            <div class="info-panels-row">
                <!-- Client Information Panel -->
                <div class="info-panel client-panel">
                    <div class="panel-header">
                        <h3>
                            <i class="bi bi-building"></i>
                            Информация за клиент
                        </h3>
                        <div class="panel-status">
                            <span class="status-badge"
                                  th:classappend="${clientInfo?.userStatus == 'ACTIVE' ? 'status-active' : 'status-inactive'}"
                                  th:text="${clientInfo?.userStatus == 'ACTIVE' ? 'Активен' : 'Неактивен'}">
                                Активен
                            </span>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="client-identity">
                            <div class="client-avatar">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="client-details">
                                <h4 class="client-name" th:text="${clientInfo?.companyName ?: 'Неизвестен клиент'}">
                                    ООД "Примерна Фирма"
                                </h4>
                                <span class="client-username" th:text="'@' + ${clientInfo?.username ?: 'unknown'}">
                                    @client_username
                                </span>
                                <div class="client-contact">
                                    <small th:if="${clientInfo?.email}" th:text="${clientInfo.email}">email@example.com</small>
                                    <small th:if="${clientInfo?.phone}" th:text="${clientInfo.phone}">+359 888 123 456</small>
                                </div>
                            </div>
                        </div>

                        <div class="client-stats">
                            <div class="stat-item">
                                <span class="stat-label">Общо поръчки:</span>
                                <span class="stat-value" th:text="${clientInfo?.totalOrders ?: '0'}">12</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Последна поръчка:</span>
                                <span class="stat-value" th:text="${clientInfo?.lastOrderDate ?: 'Няма'}">15.12.2024</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Средна стойност:</span>
                                <span class="stat-value" th:text="${clientInfo?.averageOrderValue ?: '0.00 лв'}">2,450.00 лв</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Information Panel - Зарежда се след стартиране -->
                <div class="info-panel employee-panel">
                    <div class="panel-header">
                        <h3>
                            <i class="bi bi-person-gear"></i>
                            Информация за служител
                        </h3>
                        <div class="panel-status">
                            <span id="employee-status-badge" class="status-badge status-inactive">
                                Не е започнато
                            </span>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div id="employee-placeholder" class="employee-placeholder">
                            <i class="bi bi-person-dash"></i>
                            <p>Служителят ще бъде определен след стартиране на процеса</p>
                        </div>

                        <div id="employee-details" class="employee-details hidden">
                            <div class="employee-identity">
                                <div class="employee-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="employee-info">
                                    <h4 id="employee-name">-</h4>
                                    <span id="employee-username"></span>
                                    <div class="employee-contact">
                                        <small id="employee-email">-</small>
                                        <small id="employee-phone">-</small>
                                    </div>
                                </div>
                            </div>

                            <div class="session-info">
                                <div class="info-item">
                                    <span class="info-label">Започнато:</span>
                                    <span id="session-start-time">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Време на работа:</span>
                                    <span id="session-duration">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Номер на камион:</span>
                                    <span id="active-truck-number">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="catalog-controls">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text"
                               id="search-input"
                               class="search-input"
                               placeholder="Търсене по име, SKU или описание..."
                               disabled>
                        <i class="bi bi-search search-icon"></i>
                    </div>
                </div>

                <div class="filter-container">
                    <button class="filter-btn active" data-filter="all" disabled>
                        <i class="bi bi-grid"></i> Всички
                    </button>
                    <button class="filter-btn" data-filter="loaded" disabled>
                        <i class="bi bi-check-circle"></i> Заредени
                    </button>
                    <button class="filter-btn" data-filter="pending" disabled>
                        <i class="bi bi-circle"></i> Чакащи
                    </button>
                </div>

                <div class="sort-container">
                    <select id="sort-select" class="sort-select" disabled>
                        <option value="name">По име на артикул</option>
                        <option value="category">По категория</option>
                        <option value="quantity">По количество</option>
                    </select>
                </div>
            </div>

            <!-- Main catalog container for order items -->
            <div id="items-container" class="order-items-container hidden">
                <!-- Order items will be rendered here by JavaScript -->
            </div>

            <!-- Empty state -->
            <div id="empty-state" class="empty-state hidden">
                <div class="empty-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h3>Няма артикули за товарене</h3>
                <p>Тази поръчка не съдържа артикули за товарене в камиона.</p>
            </div>

        </div>
    </div>
</section>

<!-- OBSERVER SECTION - Показва се когато някой друг товари -->
<section id="observer-section" class="order-shipping-section" style="display: none;">
    <div class="container">
        <div class="alert alert-warning mb-4">
            <i class="bi bi-eye"></i>
            <span id="observer-message">Друг служител товари тази поръчка</span>
            <div class="mt-2">
                <small id="other-activity" class="text-muted">Зареждане на информация...</small>
            </div>
        </div>

        <!-- Observer Progress (същото като в loading mode, но read-only) -->
        <div class="progress-visualization">
            <div class="progress-stats">
                <div class="stat-item">
                    <span class="stat-number" id="observer-loaded">0</span>
                    <span class="stat-label">Заредени</span>
                </div>
                <div class="stat-divider">от</div>
                <div class="stat-item">
                    <span class="stat-number" id="observer-total">0</span>
                    <span class="stat-label">Общо</span>
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div id="observer-progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <span id="observer-progress-percentage">0%</span>
            </div>
        </div>

        <!-- Read-only items view -->
        <div id="observer-items-container" class="order-items-container">
            <!-- Observer items will be rendered here -->
        </div>
    </div>
</section>

<!-- Fixed Progress Bar -->
<div class="fixed-progress-container">
    <div class="progress-content">
        <div class="progress-icon">
            <i class="bi bi-truck"></i>
        </div>
        <div class="progress-bar-section">
            <div class="progress-header">
                <span class="progress-title">Прогрес на товарене</span>
                <div class="progress-stats">
                    <span id="loaded-count">0</span> / <span id="total-count">0</span> артикула
                </div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        <div class="progress-percentage" id="progress-percentage">0%</div>
        <div class="complete-section">
            <button id="complete-loading-btn" class="complete-loading-btn" disabled>
                <i class="bi bi-check-circle"></i>
                Завърши товарене
            </button>
        </div>
    </div>
</div>

<!-- Include Footer Fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JavaScript Configuration -->
<script th:inline="javascript">
    window.orderConfig = {
        orderId: /*[[${orderId}]]*/ 0,
        orderItems: /*[[${order.items}]]*/ [],
        clientInfo: /*[[${clientInfo}]]*/ {},
        employerInfo: /*[[${loadingEmployer}]]*/ {},
        currentUserId: /*[[${currentUserId}]]*/ 0,
        currentUsername: /*[[${currentUsername}]]*/ '',
        csrfToken: /*[[${csrfToken}]]*/ '',
        csrfHeader: /*[[${csrfHeader}]]*/ '',
        loadingEmployer: /*[[${loadingEmployer}]]*/ null
    };
</script>

<div th:replace="~{fragments/bottomHtmlImports :: bottomImports}"></div>

<!-- JavaScript imports -->
<script src="/js/employersDashboard/shippingApi.js"></script>
<script src="/js/employersDashboard/order-detail-shipped.js"></script>

</body>
</html>