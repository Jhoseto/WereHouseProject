<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="bg" th:replace="layout/base :: content">
<body>
<section th:object="${order}">
    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <a th:href="@{/admin}" class="breadcrumb-link">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª</a>
        <span class="breadcrumb-separator">/</span>
        <a th:href="@{/admin/orders}" class="breadcrumb-link">–ó–∞—è–≤–∫–∏</a>
        <span class="breadcrumb-separator">/</span>
        <span>–ó–∞—è–≤–∫–∞ #<span th:text="*{id}">0</span></span>
    </div>

    <div class="order-header">
        <h1>
            üìã –ó–∞—è–≤–∫–∞ ‚Ññ <span th:text="*{id}" class="order-number">0</span>
        </h1>

        <div class="order-status-badge">
      <span th:class="'status-badge status-' + ${#strings.toLowerCase(order.status.name())}"
            th:text="*{status.name()}"
            th:attr="data-tooltip=${order.status.name() == 'SUBMITTED' ? '–ß–∞–∫–∞ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' :
                                 (order.status.name() == 'CONFIRMED' ? '–ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–∞ –∏ —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞' :
                                 (order.status.name() == 'SHIPPED' ? '–ò–∑–ø—Ä–∞—Ç–µ–Ω–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞' :
                                 (order.status.name() == 'CANCELLED' ? '–ó–∞—è–≤–∫–∞—Ç–∞ –µ –æ—Ç–º–µ–Ω–µ–Ω–∞' : order.status.name())))}">
        SUBMITTED
      </span>
        </div>
    </div>

    <!-- Order and client information -->
    <div class="order-info-grid">
        <div class="order-info-card">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <div class="info-row">
                <span class="info-label">–ö–ª–∏–µ–Ω—Ç:</span>
                <span class="info-value client-name" th:text="*{client.name}">Client Name</span>
            </div>
            <div class="info-row">
                <span class="info-label">–ö–æ–¥:</span>
                <span class="info-value client-code" th:text="*{client.clientCode}">C001</span>
            </div>
            <div th:if="*{client.email}" class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">
          <a th:href="'mailto:' + *{client.email}" th:text="*{client.email}">email@example.com</a>
        </span>
            </div>
            <div th:if="*{client.phone}" class="info-row">
                <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                <span class="info-value">
          <a th:href="'tel:' + *{client.phone}" th:text="*{client.phone}">+359888123456</a>
        </span>
            </div>
        </div>

        <div class="order-info-card">
            <h3>üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∑–∞—è–≤–∫–∞—Ç–∞</h3>
            <div class="info-row">
                <span class="info-label">–ü–æ–¥–∞–¥–µ–Ω–∞ –Ω–∞:</span>
                <span class="info-value" th:text="${#temporals.format(order.submittedAt, 'dd.MM.yyyy HH:mm:ss')}">01.01.2025 12:00:00</span>
            </div>
            <div th:if="*{confirmedAt != null}" class="info-row">
                <span class="info-label">–ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–∞ –Ω–∞:</span>
                <span class="info-value confirmed-date" th:text="${#temporals.format(order.confirmedAt, 'dd.MM.yyyy HH:mm:ss')}">01.01.2025 13:00:00</span>
            </div>
            <div th:if="*{notes != null and not #strings.isEmpty(notes)}" class="info-row">
                <span class="info-label">–ë–µ–ª–µ–∂–∫–∏:</span>
                <div class="info-value notes-content" th:text="*{notes}">Order notes</div>
            </div>
        </div>

        <!-- Order summary -->
        <div class="order-summary-card">
            <h3>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="summary-row">
                <span>–ù–µ—Ç–æ —Å—É–º–∞:</span>
                <span th:text="${#numbers.formatDecimal(order.totalNet,1,2)} + ' –ª–≤'">0.00 –ª–≤</span>
            </div>
            <div class="summary-row">
                <span>–î–î–°:</span>
                <span th:text="${#numbers.formatDecimal(order.totalVat,1,2)} + ' –ª–≤'">0.00 –ª–≤</span>
            </div>
            <div class="summary-row total-row">
                <span>–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞:</span>
                <strong class="total-amount" th:text="${#numbers.formatDecimal(order.totalGross,1,2)} + ' –ª–≤'">0.00 –ª–≤</strong>
            </div>
        </div>
    </div>

    <!-- Order items -->
    <div class="order-items-section">
        <h3>üì¶ –ü—Ä–æ–¥—É–∫—Ç–∏ –≤ –∑–∞—è–≤–∫–∞—Ç–∞</h3>

        <div class="table-responsive">
            <table class="table order-items-table">
                <thead>
                <tr>
                    <th>SKU</th>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–ö-–≤–æ</th>
                    <th>–ï–¥. —Ü–µ–Ω–∞</th>
                    <th>–û–±—â–æ</th>
                    <th>–ë–µ–ª–µ–∂–∫–∞</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : *{items}" class="order-item-row">
                    <td class="sku-cell">
                        <code th:text="${item.product.sku}">SKU</code>
                    </td>
                    <td class="product-cell">
                        <div class="product-name" th:text="${item.product.name}">Product Name</div>
                        <div th:if="${item.product.category}" class="product-category">
                            <span class="category-badge" th:text="${item.product.category}">Category</span>
                        </div>
                    </td>
                    <td class="quantity-cell">
                        <span class="quantity" th:text="${#numbers.formatDecimal(item.qty, 0, 0)}">1</span>
                        <span class="unit" th:text="${item.product.unit}">pcs</span>
                    </td>
                    <td class="price-cell">
                        <span th:text="${#numbers.formatDecimal(item.unitPrice,1,2)} + ' –ª–≤'">0.00 –ª–≤</span>
                    </td>
                    <td class="total-cell">
                        <strong th:text="${#numbers.formatDecimal(item.unitPrice.multiply(item.qty),1,2)} + ' –ª–≤'">0.00 –ª–≤</strong>
                    </td>
                    <td class="note-cell">
              <span th:if="${item.note != null and not #strings.isEmpty(item.note)}"
                    class="item-note"
                    th:text="${item.note}">
                Note
              </span>
                        <span th:unless="${item.note != null and not #strings.isEmpty(item.note)}"
                              class="text-muted">‚Äî</span>
                    </td>
                </tr>
                </tbody>
                <tfoot>
                <tr class="totals-row">
                    <td colspan="4" class="totals-label">–û–±—â–æ:</td>
                    <td class="totals-value">
                        <strong th:text="${#numbers.formatDecimal(order.totalNet,1,2)} + ' –ª–≤'">0.00 –ª–≤</strong>
                    </td>
                    <td></td>
                </tr>
                <tr class="totals-row">
                    <td colspan="4" class="totals-label">–î–î–°:</td>
                    <td class="totals-value">
                        <strong th:text="${#numbers.formatDecimal(order.totalVat,1,2)} + ' –ª–≤'">0.00 –ª–≤</strong>
                    </td>
                    <td></td>
                </tr>
                <tr class="grand-total-row">
                    <td colspan="4" class="totals-label">–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞:</td>
                    <td class="totals-value">
                        <strong class="grand-total" th:text="${#numbers.formatDecimal(order.totalGross,1,2)} + ' –ª–≤'">0.00 –ª–≤</strong>
                    </td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Admin actions -->
    <div class="admin-actions-section">
        <h3>üõ†Ô∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—è</h3>

        <div class="actions-grid">
            <!-- Confirm order -->
            <div th:if="${canConfirm}" class="action-card confirm-action">
                <div class="action-header">
                    <div class="action-icon">‚úÖ</div>
                    <div class="action-title">–ü–æ—Ç–≤—ä—Ä–¥–∏ –∑–∞—è–≤–∫–∞—Ç–∞</div>
                </div>
                <div class="action-content">
                    <p>–ü–æ—Ç–≤—ä—Ä–∂–¥–∞–≤–∞–Ω–µ—Ç–æ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ –∑–∞—è–≤–∫–∞—Ç–∞ –µ –æ–¥–æ–±—Ä–µ–Ω–∞ –∏ –º–æ–∂–µ –¥–∞ —Å–µ –æ–±—Ä–∞–±–æ—Ç–∏.</p>
                    <form method="post" th:action="@{'/admin/orders/' + *{id} + '/confirm'}" class="action-form">
                        <div th:replace="~{layout/fragments :: csrf}"></div>
                        <button type="submit" class="btn btn-success" onclick="return confirmAction('–ø–æ—Ç–≤—ä—Ä–∂–¥–∞–≤–∞–Ω–µ', [[*{id}]])">
                            <span class="nav-icon">‚úÖ</span> –ü–æ—Ç–≤—ä—Ä–¥–∏ –∑–∞—è–≤–∫–∞—Ç–∞
                        </button>
                    </form>
                </div>
            </div>

            <!-- Cancel order -->
            <div th:if="${canCancel}" class="action-card cancel-action">
                <div class="action-header">
                    <div class="action-icon">‚ùå</div>
                    <div class="action-title">–û—Ç–º–µ–Ω–∏ –∑–∞—è–≤–∫–∞—Ç–∞</div>
                </div>
                <div class="action-content">
                    <p>–û—Ç–º—è–Ω–∞—Ç–∞ –Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞ —è –º–∞—Ä–∫–∏—Ä–∞ –∫–∞—Ç–æ –Ω–µ–∏–∑–ø—ä–ª–Ω–∏–º–∞.</p>
                    <form method="post" th:action="@{'/admin/orders/' + *{id} + '/cancel'}" class="action-form">
                        <div th:replace="~{layout/fragments :: csrf}"></div>
                        <div class="form-group">
                            <label for="cancelReason">–ü—Ä–∏—á–∏–Ω–∞ –∑–∞ –æ—Ç–º—è–Ω–∞:</label>
                            <textarea id="cancelReason" name="reason" required rows="3" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –ø—Ä–∏—á–∏–Ω–∞—Ç–∞ –∑–∞ –æ—Ç–º—è–Ω–∞—Ç–∞..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger" onclick="return confirmCancel()">
                            <span class="nav-icon">‚ùå</span> –û—Ç–º–µ–Ω–∏ –∑–∞—è–≤–∫–∞—Ç–∞
                        </button>
                    </form>
                </div>
            </div>

            <!-- Ship order -->
            <div th:if="*{status.name() == 'CONFIRMED'}" class="action-card ship-action">
                <div class="action-header">
                    <div class="action-icon">üöö</div>
                    <div class="action-title">–ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞</div>
                </div>
                <div class="action-content">
                    <p>–ú–∞—Ä–∫–∏—Ä–∞–π—Ç–µ –∑–∞—è–≤–∫–∞—Ç–∞ –∫–∞—Ç–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞ –∫–æ–≥–∞—Ç–æ –µ –≥–æ—Ç–æ–≤–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞.</p>
                    <form method="post" th:action="@{'/admin/orders/' + *{id} + '/ship'}" class="action-form">
                        <div th:replace="~{layout/fragments :: csrf}"></div>
                        <div class="form-group">
                            <label for="trackingNumber">–ù–æ–º–µ—Ä –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ):</label>
                            <input type="text" id="trackingNumber" name="trackingNumber" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ tracking –Ω–æ–º–µ—Ä..." />
                        </div>
                        <button type="submit" class="btn btn-success" onclick="return confirmAction('–º–∞—Ä–∫–∏—Ä–∞–Ω–µ –∫–∞—Ç–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞', [[*{id}]])">
                            <span class="nav-icon">üöö</span> –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation actions -->
    <div class="order-actions">
        <a th:href="@{/admin/orders}" class="btn btn-secondary">
            <span class="nav-icon">üìã</span> –û–±—Ä–∞—Ç–Ω–æ –∫—ä–º –∑–∞—è–≤–∫–∏—Ç–µ
        </a>

        <button onclick="window.print()" class="btn btn-secondary">
            <span class="nav-icon">üñ®Ô∏è</span> –ü—Ä–∏–Ω—Ç–∏—Ä–∞–π
        </button>

        <a th:href="@{/admin}" class="btn btn-secondary">
            <span class="nav-icon">‚öôÔ∏è</span> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª
        </a>
    </div>
</section>

<style>
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .order-number {
        color: #3498db;
        font-family: monospace;
    }

    .order-status-badge {
        align-self: flex-start;
    }

    .order-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
    }

    .order-info-card, .order-summary-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .order-info-card h3, .order-summary-card h3 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .info-row {
        display: flex;
        margin-bottom: 12px;
        align-items: flex-start;
    }

    .info-label {
        font-weight: 600;
        color: #2c3e50;
        min-width: 120px;
        margin-right: 15px;
    }

    .info-value {
        color: #495057;
        flex: 1;
    }

    .client-name {
        font-weight: 600;
        color: #2c3e50;
    }

    .client-code {
        font-family: monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
    }

    .confirmed-date {
        color: #27ae60;
        font-weight: 600;
    }

    .notes-content {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border-left: 3px solid #3498db;
        white-space: pre-wrap;
        font-style: italic;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .total-row {
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid #eee;
        border-bottom: none;
    }

    .total-amount {
        color: #27ae60;
        font-size: 1.2rem;
    }

    .order-items-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .order-items-section h3 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .admin-actions-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .admin-actions-section h3 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .action-card {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .confirm-action {
        border-color: #27ae60;
        background: #f8fff9;
    }

    .confirm-action:hover {
        border-color: #229954;
    }

    .cancel-action {
        border-color: #e74c3c;
        background: #fef9f9;
    }

    .cancel-action:hover {
        border-color: #c0392b;
    }

    .ship-action {
        border-color: #3498db;
        background: #f8fcff;
    }

    .ship-action:hover {
        border-color: #2980b9;
    }

    .action-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .action-icon {
        font-size: 1.5rem;
    }

    .action-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .action-content p {
        color: #6c757d;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }

    .action-form {
        margin: 0;
    }

    .action-form .form-group {
        margin-bottom: 15px;
    }

    .action-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .action-form input, .action-form textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .action-form textarea {
        resize: vertical;
        min-height: 80px;
    }

    .order-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    /* Inherit styles from client order detail */
    .order-items-table .sku-cell {
        font-family: monospace;
        background: #f8f9fa;
    }

    .order-items-table .sku-cell code {
        background: none;
        color: #2c3e50;
        font-weight: 600;
    }

    .product-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .category-badge {
        display: inline-block;
        background: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .quantity-cell {
        text-align: center;
    }

    .quantity {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .unit {
        color: #6c757d;
        font-size: 0.85rem;
        margin-left: 4px;
    }

    .price-cell, .total-cell {
        text-align: right;
        font-family: monospace;
    }

    .total-cell strong {
        color: #27ae60;
    }

    .item-note {
        font-style: italic;
        color: #6c757d;
        font-size: 0.9rem;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .totals-row, .grand-total-row {
        background: #f8f9fa;
    }

    .totals-label {
        text-align: right;
        font-weight: 600;
        color: #2c3e50;
    }

    .totals-value {
        text-align: right;
        font-family: monospace;
    }

    .grand-total-row {
        background: #e8f5e8;
    }

    .grand-total {
        color: #27ae60;
        font-size: 1.1rem;
    }

    .text-muted {
        color: #6c757d;
    }

    /* Print styles */
    @media print {
        .breadcrumbs,
        .order-actions,
        .admin-actions-section,
        .site-header,
        .site-footer,
        .flash-messages {
            display: none !important;
        }

        body {
            background: white !important;
        }

        .container {
            max-width: none !important;
            padding: 0 !important;
        }

        .order-info-card, .order-summary-card, .order-items-section {
            box-shadow: none !important;
            border: 1px solid #ddd;
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .order-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .order-info-grid {
            grid-template-columns: 1fr;
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }

        .info-row {
            flex-direction: column;
        }

        .info-label {
            min-width: auto;
            margin-right: 0;
            margin-bottom: 4px;
        }

        .order-actions {
            flex-direction: column;
        }
    }
</style>

<script>
    function confirmAction(action, orderId) {
        return confirm(`–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑–≤—ä—Ä—à–∏—Ç–µ ${action} –Ω–∞ –∑–∞—è–≤–∫–∞ #${orderId}?`);
    }

    function confirmCancel() {
        const reason = document.getElementById('cancelReason').value.trim();
        if (!reason) {
            alert('–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –ø—Ä–∏—á–∏–Ω–∞ –∑–∞ –æ—Ç–º—è–Ω–∞—Ç–∞.');
            return false;
        }
        return confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –æ—Ç–º–µ–Ω–∏—Ç–µ —Ç–∞–∑–∏ –∑–∞—è–≤–∫–∞?');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add loading states to action buttons
        const actionButtons = document.querySelectorAll('.action-form button[type="submit"]');
        actionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                const form = this.closest('form');
                const action = form.getAttribute('action');

                // Don't show loading if confirmation is cancelled
                setTimeout(() => {
                    if (this.getAttribute('onclick')) {
                        const confirmed = eval(this.getAttribute('onclick'));
                        if (confirmed) {
                            const originalText = this.innerHTML;
                            this.innerHTML = '<span class="loading"></span> –û–±—Ä–∞–±–æ—Ç–≤–∞...';
                            this.disabled = true;
                        }
                    }
                }, 100);
            });
        });
    });
</script>
</body>
</html>