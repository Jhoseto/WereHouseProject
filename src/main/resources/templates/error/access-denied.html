<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>403 - Отказан достъп | Warehouse Portal</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Error Styles -->
    <link rel="stylesheet" href="/css/error.css">
</head>
<body class="error-page">
<section>
    <div class="error-container">
        <div class="error-visual">
            <div class="error-number">403</div>
            <div class="error-icon">
                <i class="bi bi-shield-exclamation"></i>
            </div>
        </div>

        <div class="error-content">
            <h1 class="error-title">Отказан достъп</h1>
            <p class="error-message">
                Съжаляваме, но нямате права за достъп до тази страница или ресурс.
                Възможно е да се нуждаете от по-високи права или да не сте влезли в системата.
            </p>

            <div class="error-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Необходима е автентикация или авторизация</span>
                </div>
                <small class="text-muted">
                    Моля, влезте в профила си или се свържете с администратор
                </small>
            </div>

            <div class="error-suggestions">
                <h3>
                    <i class="bi bi-lightbulb"></i>
                    Възможни причини
                </h3>
                <div class="suggestions-grid">
                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-person-x"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Не сте влезли в системата</h4>
                            <p>Тази страница изисква да бъдете автентикирани в системата</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-shield-slash"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Недостатъчни права</h4>
                            <p>Вашият потребителски профил няма права за достъп до този ресурс</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Изтекла сесия</h4>
                            <p>Възможно е вашата сесия да е изтекла и да трябва да влезете отново</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-person-gear"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Нужда от администратор</h4>
                            <p>Свържете се с администратор за предоставяне на необходимите права</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="error-actions">
                <a th:href="@{/login}" class="btn" sec:authorize="!isAuthenticated()">
                    <i class="bi bi-box-arrow-in-right nav-icon"></i>
                    Влезте в системата
                </a>
                <a th:href="@{/}" class="btn btn-secondary">
                    <i class="bi bi-house nav-icon"></i>
                    Начална страница
                </a>
                <button onclick="history.back()" class="btn btn-secondary">
                    <i class="bi bi-arrow-left nav-icon"></i>
                    Назад
                </button>
            </div>

            <div sec:authorize="isAuthenticated()" class="error-details">
                <h3>
                    <i class="bi bi-info-circle"></i>
                    Информация за текущия потребител
                </h3>
                <p>
                    Влезли сте като: <strong sec:authentication="name">username</strong><br>
                    Роли: <span sec:authentication="authorities">roles</span>
                </p>
            </div>

            <div class="helpful-links">
                <h4>
                    <i class="bi bi-compass"></i>
                    Налични ресурси
                </h4>
                <div class="links-grid">
                    <a th:href="@{/catalog}" class="help-link">
                        <i class="bi bi-box-seam link-icon"></i>
                        <span class="link-text">Каталог продукти</span>
                    </a>
                    <a th:href="@{/orders}" class="help-link" sec:authorize="hasRole('CLIENT')">
                        <i class="bi bi-list-check link-icon"></i>
                        <span class="link-text">Моите заявки</span>
                    </a>
                    <a th:href="@{/templates/employer}" class="help-link" sec:authorize="hasRole('ADMIN')">
                        <i class="bi bi-gear link-icon"></i>
                        <span class="link-text">Админ панел</span>
                    </a>
                    <a th:href="@{/about}" class="help-link">
                        <i class="bi bi-info-square link-icon"></i>
                        <span class="link-text">За системата</span>
                    </a>
                    <a th:href="@{/login}" class="help-link" sec:authorize="!isAuthenticated()">
                        <i class="bi bi-box-arrow-in-right link-icon"></i>
                        <span class="link-text">Вход в системата</span>
                    </a>
                    <a th:href="@{/logout}" class="help-link" sec:authorize="isAuthenticated()">
                        <i class="bi bi-box-arrow-right link-icon"></i>
                        <span class="link-text">Изход от системата</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Track access denied events for security monitoring
        console.warn('Access Denied tracked:', {
            url: window.location.pathname,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            referrer: document.referrer
        });

        // Add click tracking for recovery actions
        const actionButtons = document.querySelectorAll('.error-actions .btn, .help-link');
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('Access denied recovery action clicked:', this.textContent.trim());
            });
        });

        // Add keyboard shortcuts for quick navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'l' && e.ctrlKey) {
                e.preventDefault();
                // Navigate to login page if not authenticated
                const loginLink = document.querySelector('a[href*="/login"]');
                if (loginLink) {
                    loginLink.click();
                }
            } else if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                window.location.href = '/';
            } else if (e.key === 'b' && e.ctrlKey) {
                e.preventDefault();
                history.back();
            }
        });

        // Auto-refresh authentication status periodically (every 5 minutes)
        setInterval(function() {
            fetch('/api/auth/status', {
                method: 'GET',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.authenticated) {
                        console.log('User authentication status updated');
                        // Optionally reload page if user has gained access
                        // location.reload();
                    }
                })
                .catch(error => {
                    console.log('Authentication status check failed:', error);
                });
        }, 300000); // 5 minutes
    });
</script>
</body>
</html>