<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>500 - Вътрешна грешка | Warehouse Portal</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Error Styles -->
    <link rel="stylesheet" href="/css/error.css">
</head>
<body class="error-page">
<section>
    <div class="error-container">
        <div class="error-visual">
            <div class="error-number">500</div>
            <div class="error-icon">
                <i class="bi bi-tools"></i>
            </div>
        </div>

        <div class="error-content">
            <h1 class="error-title">Вътрешна грешка на сървъра</h1>
            <p class="error-message">
                Съжаляваме, възникна неочаквана грешка в системата. Нашият технически екип е автоматично
                уведомен за проблема и работи по отстраняването му. Моля, опитайте отново след няколко минути.
            </p>

            <div class="error-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Системата работи с ограничения</span>
                </div>
                <small class="text-muted">
                    Ако проблемът продължава, моля свържете се с техническата поддръжка
                </small>
            </div>

            <div class="error-suggestions">
                <h3>
                    <i class="bi bi-lightbulb"></i>
                    Какво можете да направите
                </h3>
                <div class="suggestions-grid">
                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-arrow-clockwise"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Презаредете страницата</h4>
                            <p>Възможно е грешката да е временна и да се реши при ново зареждане</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Изчакайте няколко минути</h4>
                            <p>Системата може да е временно претоварена или в процес на обновление</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Проверете действието</h4>
                            <p>Уверете се, че извършвате валидно действие с правилни данни</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-house"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Върнете се към началото</h4>
                            <p>Започнете отново от началната страница и повторете действието</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="error-actions">
                <button onclick="location.reload()" class="btn">
                    <i class="bi bi-arrow-clockwise nav-icon"></i>
                    Презареди страницата
                </button>
                <a th:href="@{/}" class="btn btn-secondary">
                    <i class="bi bi-house nav-icon"></i>
                    Начална страница
                </a>
                <button onclick="history.back()" class="btn btn-secondary">
                    <i class="bi bi-arrow-left nav-icon"></i>
                    Назад
                </button>
            </div>

            <div class="helpful-links">
                <h4>
                    <i class="bi bi-compass"></i>
                    Алтернативни действия
                </h4>
                <div class="links-grid">
                    <a th:href="@{/catalog}" class="help-link">
                        <i class="bi bi-box-seam link-icon"></i>
                        <span class="link-text">Разгледай каталога</span>
                    </a>
                    <a th:href="@{/orders}" class="help-link" sec:authorize="hasRole('CLIENT')">
                        <i class="bi bi-list-check link-icon"></i>
                        <span class="link-text">Моите заявки</span>
                    </a>
                    <a th:href="@{/admin}" class="help-link" sec:authorize="hasRole('ADMIN')">
                        <i class="bi bi-gear link-icon"></i>
                        <span class="link-text">Админ панел</span>
                    </a>
                    <a th:href="@{/about}" class="help-link">
                        <i class="bi bi-info-square link-icon"></i>
                        <span class="link-text">За системата</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Track 500 errors for analytics and monitoring
        console.error('500 Server Error tracked:', {
            url: window.location.pathname,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            referrer: document.referrer
        });

        // Optional auto-retry functionality with exponential backoff
        let retryCount = 0;
        const maxRetries = 2;
        const baseDelay = 15000; // 15 seconds

        function scheduleAutoRetry() {
            if (retryCount < maxRetries) {
                const delay = baseDelay * Math.pow(2, retryCount); // Exponential backoff
                retryCount++;

                console.log(`Scheduling auto-retry ${retryCount}/${maxRetries} in ${delay/1000} seconds`);

                setTimeout(() => {
                    console.log(`Auto-retry attempt ${retryCount}/${maxRetries}`);
                    location.reload();
                }, delay);
            }
        }

        // Uncomment the line below to enable auto-retry functionality
        // scheduleAutoRetry();

        // Add click tracking for error recovery actions
        const actionButtons = document.querySelectorAll('.error-actions .btn, .help-link');
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('500 recovery action clicked:', this.textContent.trim());
            });
        });

        // Add keyboard shortcuts for quick recovery
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                location.reload();
            } else if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                window.location.href = '/';
            }
        });

        // Monitor for network connectivity issues
        window.addEventListener('online', function() {
            console.log('Network connection restored');
            // Optionally show a notification that connection is back
        });

        window.addEventListener('offline', function() {
            console.log('Network connection lost');
            // Optionally show offline indicator
        });
    });
</script>
</body>
</html>