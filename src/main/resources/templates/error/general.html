<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Грешка в системата | Warehouse Portal</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Error Styles -->
    <link rel="stylesheet" href="/css/error.css">
</head>
<body class="error-page">
<section>
    <div class="error-container">
        <div class="error-visual">
            <div class="error-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
        </div>

        <div class="error-content">
            <h1 class="error-title">Възникна грешка</h1>
            <p class="error-message">
                Съжаляваме за неудобството. Възникна неочаквана грешка при обработката на вашата заявка.
                Моля, опитайте отново или се свържете с техническата поддръжка ако проблемът продължава.
            </p>

            <div th:if="${statusCode}" class="status-info">
                <div class="status-badge">
                    <i class="bi bi-info-circle"></i>
                    <span class="status-code" th:text="'Код на грешката: ' + ${statusCode}">Код: 400</span>
                </div>
            </div>

            <div th:if="${error}" class="error-details">
                <h3>
                    <i class="bi bi-bug"></i>
                    Детайли за грешката
                </h3>
                <p th:text="${error}">Error description</p>
            </div>

            <div class="error-suggestions">
                <h3>
                    <i class="bi bi-lightbulb"></i>
                    Възможни решения
                </h3>
                <div class="suggestions-grid">
                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-arrow-clockwise"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Опитайте отново</h4>
                            <p>Презаредете страницата и повторете действието - възможно е грешката да е временна</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-arrow-left"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Върнете се назад</h4>
                            <p>Използвайте бутона "Назад" или се върнете към предишната страница</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Проверете данните</h4>
                            <p>Уверете се, че сте въвели правилна информация във всички полета</p>
                        </div>
                    </div>

                    <div class="suggestion-card">
                        <div class="suggestion-icon">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="suggestion-content">
                            <h4>Изчакайте малко</h4>
                            <p>Възможно е системата да е временно претоварена - опитайте след няколко минути</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="error-actions">
                <button onclick="location.reload()" class="btn">
                    <i class="bi bi-arrow-clockwise nav-icon"></i>
                    Презареди
                </button>
                <button onclick="history.back()" class="btn btn-secondary">
                    <i class="bi bi-arrow-left nav-icon"></i>
                    Назад
                </button>
                <a th:href="@{/}" class="btn btn-secondary">
                    <i class="bi bi-house nav-icon"></i>
                    Начало
                </a>
            </div>

            <div class="technical-info hidden" id="technicalInfo">
                <h4>
                    <i class="bi bi-gear"></i>
                    Техническа информация
                </h4>
                <div class="tech-details">
                    <div class="tech-item">
                        <span class="tech-label">URL:</span>
                        <span class="tech-value" id="currentUrl">—</span>
                    </div>
                    <div class="tech-item">
                        <span class="tech-label">Време:</span>
                        <span class="tech-value" id="errorTime">—</span>
                    </div>
                    <div class="tech-item">
                        <span class="tech-label">Browser:</span>
                        <span class="tech-value" id="userAgent">—</span>
                    </div>
                    <div th:if="${statusCode}" class="tech-item">
                        <span class="tech-label">HTTP Status:</span>
                        <span class="tech-value" th:text="${statusCode}">—</span>
                    </div>
                    <div class="tech-item">
                        <span class="tech-label">Referrer:</span>
                        <span class="tech-value" id="referrerUrl">—</span>
                    </div>
                </div>
            </div>

            <div class="helpful-links">
                <h4>
                    <i class="bi bi-compass"></i>
                    Полезни връзки
                </h4>
                <div class="links-grid">
                    <a th:href="@{/catalog}" class="help-link">
                        <i class="bi bi-box-seam link-icon"></i>
                        <span class="link-text">Каталог продукти</span>
                    </a>
                    <a th:href="@{/orders}" class="help-link" sec:authorize="hasRole('CLIENT')">
                        <i class="bi bi-list-check link-icon"></i>
                        <span class="link-text">Моите заявки</span>
                    </a>
                    <a th:href="@{/cart}" class="help-link" sec:authorize="hasRole('CLIENT')">
                        <i class="bi bi-cart link-icon"></i>
                        <span class="link-text">Кошница</span>
                    </a>
                    <a th:href="@{/admin}" class="help-link" sec:authorize="hasRole('ADMIN')">
                        <i class="bi bi-gear link-icon"></i>
                        <span class="link-text">Админ панел</span>
                    </a>
                    <a th:href="@{/about}" class="help-link">
                        <i class="bi bi-info-square link-icon"></i>
                        <span class="link-text">За системата</span>
                    </a>
                </div>
            </div>

            <div class="debug-actions">
                <button onclick="toggleTechnicalInfo()" class="debug-btn">
                    <i class="bi bi-code-slash nav-icon"></i>
                    Техническа информация
                </button>
            </div>
        </div>
    </div>
</section>

<script>
    function toggleTechnicalInfo() {
        const techInfo = document.getElementById('technicalInfo');
        const button = document.querySelector('.debug-btn');

        if (techInfo.classList.contains('hidden')) {
            // Show technical information and populate it
            populateTechnicalInfo();
            techInfo.classList.remove('hidden');
            button.innerHTML = '<i class="bi bi-eye-slash nav-icon"></i> Скрий техническата информация';
        } else {
            // Hide technical information
            techInfo.classList.add('hidden');
            button.innerHTML = '<i class="bi bi-code-slash nav-icon"></i> Техническа информация';
        }
    }

    function populateTechnicalInfo() {
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('errorTime').textContent = new Date().toLocaleString('bg-BG');
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('referrerUrl').textContent = document.referrer || 'Няма';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Track general errors for analytics and debugging
        const errorInfo = {
            url: window.location.pathname,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            referrer: document.referrer,
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            },
            error: '[[${error}]]' || 'Unknown error',
            statusCode: '[[${statusCode}]]' || null
        };

        console.error('General Error tracked:', errorInfo);

        // Add click tracking for recovery actions
        const actionButtons = document.querySelectorAll('.error-actions .btn, .help-link');
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('Error recovery action clicked:', {
                    action: this.textContent.trim(),
                    timestamp: new Date().toISOString()
                });
            });
        });

        // Add keyboard shortcuts for common actions
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                location.reload();
            } else if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                window.location.href = '/';
            } else if (e.key === 'b' && e.ctrlKey) {
                e.preventDefault();
                history.back();
            } else if (e.key === 't' && e.ctrlKey) {
                e.preventDefault();
                toggleTechnicalInfo();
            }
        });

        // Auto-hide technical info after 60 seconds if shown
        let techInfoTimeout;
        const originalToggle = window.toggleTechnicalInfo;
        window.toggleTechnicalInfo = function() {
            originalToggle();
            const techInfo = document.getElementById('technicalInfo');

            if (!techInfo.classList.contains('hidden')) {
                clearTimeout(techInfoTimeout);
                techInfoTimeout = setTimeout(() => {
                    techInfo.classList.add('hidden');
                    document.querySelector('.debug-btn').innerHTML =
                        '<i class="bi bi-code-slash nav-icon"></i> Техническа информация';
                }, 60000); // Auto-hide after 60 seconds
            }
        };

        // Monitor for performance issues
        if ('performance' in window) {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData && perfData.loadEventEnd > 3000) {
                console.warn('Page load took longer than expected:', perfData.loadEventEnd + 'ms');
            }
        }

        // Check for network connectivity
        if (!navigator.onLine) {
            console.warn('User appears to be offline');
            // Optionally show offline indicator
        }

        window.addEventListener('online', function() {
            console.log('Network connection restored');
        });

        window.addEventListener('offline', function() {
            console.warn('Network connection lost');
        });
    });
</script>
</body>
</html>